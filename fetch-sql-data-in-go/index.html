<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon-CZmGzRYx.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon-32x32-DP1DxnU_.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16x16-Kadj5d8W.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="icon" type="image/x-icon" href="./assets/favicon-BMb_UXWT.ico">
    <link rel="icon" type="image/png" sizes="192x192" href="./assets/android-chrome-192x192-BpdikjYN.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./assets/android-chrome-512x512-DOTu-18w.png">
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark-dimmed.min.css"
      referrerpolicy="no-referrer" />
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              brand: '#38bdf8',
              ink: '#0f172a'
            }
          }
        }
      };
    </script>
    <title>Nahornyi Oleh</title>
    <script type="module" crossorigin src="./assets/index-CFBjKLKn.js"></script>
    <link rel="stylesheet" crossorigin href="./assets/index-DNBYTDzq.css">
  </head>

  <body class="min-h-screen bg-slate-950 font-sans text-slate-100">
    <div class="min-h-screen bg-gradient-to-br from-indigo-700 via-fuchsia-950 to-black/90">
      <header class="sticky top-0 z-50 border-b border-slate-800/60 bg-slate-950/70 backdrop-blur">
        <div class="mx-auto flex max-w-full flex-wrap items-center justify-between gap-4 px-6 py-4">
          <a class="group flex items-center gap-2 text-slate-100" href="/">
            <h1 class="text-xl font-semibold tracking-wide transition-colors group-hover:text-brand">Oleh Nahornyi</h1>
          </a>
          <system-clock class="hidden text-sm text-slate-300 sm:block"></system-clock>
          <div class="flex items-center gap-4 text-slate-200">
            <a class="transition-colors hover:text-brand" href="https://github.com/oleg578/" target="_blank"
              rel="noopener noreferrer" aria-label="GitHub">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="h-5 w-5" fill="currentColor">
                <path
                  d="M165.9 397.4c0 2-2.3 3.7-5.2 3.7-2.9 .3-5.2-1.4-5.2-3.7 0-2 2.3-3.7 5.2-3.7 2.9-.3 5.2 1.4 5.2 3.7zm-30.4-3.2c-.7 2 .7 4.3 3.1 5.2 2.3 .7 5-.3 5.6-2.3 .7-2-.7-4.3-3.1-5.2-2.3-.7-5 .3-5.6 2.3zm44.2-1.7c-2.9 .7-4.8 2.7-4.5 4.8 .3 2 2.9 3.1 5.9 2.4 2.9-.7 4.8-2.7 4.5-4.8-.3-2-3-3.1-5.9-2.4zm44.2-1.7c-2.9 .7-4.8 2.7-4.5 4.8 .3 2 2.9 3.1 5.9 2.4 2.9-.7 4.8-2.7 4.5-4.8-.3-2-3-3.1-5.9-2.4zm44.2-1.7c-2.9 .7-4.8 2.7-4.5 4.8 .3 2 2.9 3.1 5.9 2.4 2.9-.7 4.8-2.7 4.5-4.8-.3-2-3-3.1-5.9-2.4zm44.2-1.7c-2.9 .7-4.8 2.7-4.5 4.8 .3 2 2.9 3.1 5.9 2.4 2.9-.7 4.8-2.7 4.5-4.8-.3-2-3-3.1-5.9-2.4zm44.2-1.7c-2.9 .7-4.8 2.7-4.5 4.8 .3 2 2.9 3.1 5.9 2.4 2.9-.7 4.8-2.7 4.5-4.8-.3-2-3-3.1-5.9-2.4zm44.2-1.7c-2.9 .7-4.8 2.7-4.5 4.8 .3 2 2.9 3.1 5.9 2.4 2.9-.7 4.8-2.7 4.5-4.8-.3-2-3-3.1-5.9-2.4zM248 8C111 8 0 119 0 256c0 110.3 71.3 203.9 170.7 237.2 12.5 2.3 17.1-5.4 17.1-12v-44.1c-69.5 15.1-84.1-33.7-84.1-33.7-11.4-29-27.9-36.7-27.9-36.7-22.8-15.6 1.7-15.3 1.7-15.3 25.2 1.8 38.5 25.9 38.5 25.9 22.4 38.4 58.7 27.3 73 20.9 2.3-16.2 8.7-27.3 15.8-33.6-55.5-6.3-113.9-27.7-113.9-123.1 0-27.2 9.7-49.4 25.6-66.8-2.6-6.3-11.1-31.8 2.4-66.3 0 0 21-6.7 68.8 25.5 20-5.6 41.5-8.4 62.9-8.5 21.4 .1 42.9 2.9 62.9 8.5 47.8-32.2 68.8-25.5 68.8-25.5 13.5 34.5 5 60 2.4 66.3 15.9 17.4 25.6 39.6 25.6 66.8 0 95.6-58.5 116.7-114.1 122.9 8.9 7.7 16.8 22.9 16.8 46.1v68.3c0 6.7 4.6 14.4 17.1 12C424.7 459.9 496 366.3 496 256 496 119 385 8 248 8z" />
              </svg>
            </a>
            <a class="transition-colors hover:text-brand" href="https://www.linkedin.com/in/oleh-nahornyi-b1524350/"
              target="_blank" rel="noopener noreferrer" aria-label="LinkedIn">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="h-5 w-5" fill="currentColor">
                <path
                  d="M100.28 448H7.4V148.9h92.88zm-46.44-340.7C24.09 107.3 0 83.2 0 53.6A53.6 53.6 0 0 1 53.6 0a53.6 53.6 0 0 1 53.6 53.6c0 29.6-24.09 53.7-53.36 53.7zM447.8 448h-92.4V302.4c0-34.7-12.4-58.4-43.3-58.4-23.6 0-37.6 15.8-43.7 31.1-2.3 5.6-2.8 13.4-2.8 21.2V448h-92.5s1.2-241.1 0-266.1h92.4v37.7c12.3-19 34.3-46.1 83.5-46.1 60.9 0 106.7 39.7 106.7 125.2V448z" />
              </svg>
            </a>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" class="h-6 w-6 text-slate-400"
              fill="currentColor" aria-hidden="true">
              <path
                d="m109-531-85-85q92-89 210-136.5T480-800q128 0 246 47.5T936-616l-85 85q-75-72-171-110.5T480-680q-104 0-200 38.5T109-531Zm169 169-84-84q59-55 132.5-84.5T480-560q80 0 153.5 29.5T766-446l-84 84q-42-38-93.5-58T480-440q-57 0-108.5 20T278-362Zm202 202q-33 0-56.5-23.5T400-240q0-33 23.5-56.5T480-320q33 0 56.5 23.5T560-240q0 33-23.5 56.5T480-160Z" />
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" class="h-6 w-6 text-slate-400"
              fill="currentColor" aria-hidden="true">
              <path
                d="M160-240q-50 0-85-35t-35-85v-240q0-50 35-85t85-35h540q50 0 85 35t35 85v240q0 50-35 85t-85 35H160Zm400-80h140q17 0 28.5-11.5T740-360v-240q0-17-11.5-28.5T700-640H560v320Zm300-60v-200h20q17 0 28.5 11.5T920-540v120q0 17-11.5 28.5T880-380h-20Z" />
            </svg>
          </div>
        </div>
      </header>
      <main id="main-content" class="mx-auto max-w-4xl px-6 py-12">
        <article
          class="overflow-hidden rounded-3xl border border-slate-800/60 bg-slate-950/70 shadow-2xl backdrop-blur">
          <div class="relative">
            <img
              src="assets/img/cover-image.webp"
              alt="Cover image for Three ways to fetch SQL data in Go" class="h-64 w-full object-cover"
              loading="lazy" />
          </div>
          <div class="space-y-10 px-8 py-10">
            <div class="flex flex-wrap items-center justify-between gap-4 text-sm text-slate-300">
              <div class="flex items-center gap-4">
                <img
                  src="https://media2.dev.to/dynamic/image/width=90,height=90,fit=cover,gravity=auto,format=auto/https%3A%2F%2Fdev-to-uploads.s3.amazonaws.com%2Fuploads%2Fuser%2Fprofile_image%2F2091508%2F629204f5-d503-4404-af9c-f4382968d3e4.jpeg"
                  alt="Oleg" class="h-12 w-12 rounded-full border border-slate-700 bg-slate-900/80 object-cover"
                  loading="lazy" />
                <div>
                  <p class="font-semibold text-slate-100">Oleg</p>
                  <p class="text-slate-400">Published Oct 2, 2024 · 7 min read</p>
                </div>
              </div>
              <div class="flex flex-wrap gap-2">
              </div>
            </div>
            <div class="space-y-4">
              <h1 class="text-3xl font-bold tracking-tight text-slate-50 sm:text-4xl">Three ways to fetch SQL data in Go
              </h1>
              <p class="text-lg text-slate-300">Introduction In this article, we explore three different approaches to
                fetching data from SQL databases in Golang: the standard method using JSON marshaling, a dynamic
                approach using maps, and an optimized method that avoids unnecessary overhead.</p>
            </div>
            <div
              class="prose prose-invert prose-headings:scroll-mt-24 prose-headings:font-semibold prose-a:text-brand prose-a:no-underline hover:prose-a:underline max-w-none"
              id="article-body">
              <h2>
                <a name="introduction" href="#introduction" title="Introduction">
                </a>
                Introduction
              </h2>

              <p>In this article, we explore three different approaches to fetching data from SQL databases in Golang:
                the standard method using JSON marshaling, a dynamic approach using maps, and an optimized method that
                avoids unnecessary overhead.</p>

              <p>In my practice, there were very frequent cases where I had to retrieve data from a database with an
                unknown structure beforehand. This often happens in the e-commerce industry.</p>

              <p>We will consider 3 methods of retrieving data, along with their advantages and disadvantages.</p>

              <p>You can get all the code of the examples from the repository <br>
                <a href="https://github.com/oleg578/dbf" target="_blank"
                  rel="noopener noreferrer">https://github.com/oleg578/dbf</a>
              </p>
              <h2>
                <a name="data-preparing" href="#data-preparing" title="Data preparing">
                </a>
                Data preparing
              </h2>

              <p>We will use the database MariaDB, because I just like this database. It has never failed me in 10 years
                of practice with a load of up to 500 million transactions per day with a data volume of up to 4
                terabytes in e-commerce. And it’s really faster than MySQL.</p>

              <p>Code for create MariaDB docker instance and seed test data are in <a
                  href="https://github.com/oleg578/dbf/tree/main/db" target="_blank"
                  rel="noopener noreferrer">https://github.com/oleg578/dbf/tree/main/db</a></p>

              <p>All examples are tested on Ubuntu 24.04.1 LTS (Noble Numbat) with 11th Gen Intel Core i5–1135G7 and
                16GiB RAM.</p>
              <h2>
                <a name="standard-way" href="#standard-way" title="Standard way">
                </a>
                Standard way
              </h2>

              <p>The standard way is trivial — we fetch rows from database into array and then Marshal it into JSON
                struct<br>
              </p>

              <div class="highlight js-code-highlight">
                <pre class="highlight go"><code><span class="n">rs</span><span class="p">,</span> <span class="n">errRs</span> <span class="o">:=</span> <span class="n">con</span><span class="o">.</span><span class="n">QueryContext</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">numbRows</span><span class="p">)</span>

<span class="o">...</span>

 <span class="k">for</span> <span class="n">rs</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">dmy</span> <span class="o">=</span> <span class="n">Dummy</span><span class="p">{}</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">rs</span><span class="o">.</span><span class="n">Scan</span><span class="p">(</span>
   <span class="o">&amp;</span><span class="n">dmy</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span>
   <span class="o">&amp;</span><span class="n">dmy</span><span class="o">.</span><span class="n">Product</span><span class="p">,</span>
   <span class="o">&amp;</span><span class="n">dmy</span><span class="o">.</span><span class="n">Description</span><span class="p">,</span>
   <span class="o">&amp;</span><span class="n">dmy</span><span class="o">.</span><span class="n">Price</span><span class="p">,</span>
   <span class="o">&amp;</span><span class="n">dmy</span><span class="o">.</span><span class="n">Qty</span><span class="p">,</span>
   <span class="o">&amp;</span><span class="n">dmy</span><span class="o">.</span><span class="n">Date</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
   <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">result</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">dmy</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">rs</span><span class="o">.</span><span class="n">Err</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="n">msg</span><span class="p">,</span> <span class="n">errRTJ</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Marshal</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
 <span class="k">if</span> <span class="n">errRTJ</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="nb">panic</span><span class="p">(</span><span class="n">errRTJ</span><span class="p">)</span>
 <span class="p">}</span>

<span class="o">...</span>

<span class="n">_</span><span class="p">,</span> <span class="n">errOut</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="o">...</span>
</code></pre>
                <div class="highlight__panel js-actions-panel">
                  <div class="highlight__panel-action js-fullscreen-code-action">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-on">
                      <title>Enter fullscreen mode</title>
                      <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
                    </svg>

                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-off">
                      <title>Exit fullscreen mode</title>
                      <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
                    </svg>

                  </div>
                </div>
              </div>


              <p>What about speed?<br>
                Test result:</p>

              <p><code>% ./db2json_struct 10000000 1&gt;/dev/null                                                                                           <br>
Elapsed time: 12631 ms, HeapAlloc = 5400.725 MB, Sys = 7099.447 MB<br>
10000000 records read</code></p>

              <p>Let’s just remember this as a starting point.</p>
              <h2>
                <a name="using-map-way" href="#using-map-way" title="Using map way">
                </a>
                Using map way
              </h2>

              <p>Next we consider fetching unknown list of columns — like “SELECT * FROM …”.<br>
                The sequence of actions is simple.<br>
                Each record will be represent as map[string]interface{}, then<br>
              </p>
              <div class="highlight js-code-highlight">
                <pre class="highlight go"><code><span class="c">// create result slice</span>
<span class="c">// numbRows is number of rows in result</span>
<span class="n">outRows</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{},</span> <span class="m">0</span><span class="p">,</span> <span class="n">numbRows</span><span class="p">)</span>
</code></pre>
                <div class="highlight__panel js-actions-panel">
                  <div class="highlight__panel-action js-fullscreen-code-action">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-on">
                      <title>Enter fullscreen mode</title>
                      <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
                    </svg>

                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-off">
                      <title>Exit fullscreen mode</title>
                      <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
                    </svg>

                  </div>
                </div>
              </div>


              <p>We will not serialize each record to save program execution time, and our actions are not complex.<br>
                See <a href="https://github.com/oleg578/dbf/tree/mapping/example" target="_blank"
                  rel="noopener noreferrer">https://github.com/oleg578/dbf/tree/mapping/example</a></p>

              <p>After fetch rows from database, we will request an slice of columns<br>
              </p>
              <div class="highlight js-code-highlight">
                <pre class="highlight go"><code><span class="n">columns</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">rs</span><span class="o">.</span><span class="n">Columns</span><span class="p">()</span>
</code></pre>
                <div class="highlight__panel js-actions-panel">
                  <div class="highlight__panel-action js-fullscreen-code-action">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-on">
                      <title>Enter fullscreen mode</title>
                      <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
                    </svg>

                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-off">
                      <title>Exit fullscreen mode</title>
                      <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
                    </svg>

                  </div>
                </div>
              </div>


              <p>Create slice of values and slice of pointers for data<br>
              </p>
              <div class="highlight js-code-highlight">
                <pre class="highlight go"><code><span class="n">values</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="k">interface</span><span class="p">{},</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span>
<span class="n">valuePointers</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="k">interface</span><span class="p">{},</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">values</span> <span class="p">{</span>
    <span class="n">valuePointers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
  <span class="p">}</span>
</code></pre>
                <div class="highlight__panel js-actions-panel">
                  <div class="highlight__panel-action js-fullscreen-code-action">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-on">
                      <title>Enter fullscreen mode</title>
                      <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
                    </svg>

                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-off">
                      <title>Exit fullscreen mode</title>
                      <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
                    </svg>

                  </div>
                </div>
              </div>


              <p>Then for each row we get the map which represent model — <a
                  href="https://github.com/oleg578/dbf/blob/mapping/sql2json.go" target="_blank"
                  rel="noopener noreferrer">https://github.com/oleg578/dbf/blob/mapping/sql2json.go</a><br>
              </p>
              <div class="highlight js-code-highlight">
                <pre class="highlight go"><code><span class="k">func</span> <span class="n">Row2Map</span><span class="p">(</span><span class="n">columns</span> <span class="p">[]</span><span class="kt">string</span><span class="p">,</span> <span class="n">values</span> <span class="p">[]</span><span class="k">interface</span><span class="p">{})</span> <span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
 <span class="n">rowMap</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">interface</span><span class="p">{})</span>
 <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"columns and values length not equal"</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">columns</span> <span class="p">{</span>
  <span class="n">rowMap</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">assignCellValue</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c">// we will help to typify the value</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="n">rowMap</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">assignCellValue</span><span class="p">(</span><span class="n">val</span> <span class="k">interface</span><span class="p">{})</span> <span class="k">interface</span><span class="p">{}</span> <span class="p">{</span>
 <span class="k">if</span> <span class="n">b</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">val</span><span class="o">.</span><span class="p">([]</span><span class="kt">byte</span><span class="p">);</span> <span class="n">ok</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">floatValue</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">ParseFloat</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="m">64</span><span class="p">);</span> <span class="n">err</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">floatValue</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kt">string</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="n">val</span>
<span class="p">}</span>
</code></pre>
                <div class="highlight__panel js-actions-panel">
                  <div class="highlight__panel-action js-fullscreen-code-action">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-on">
                      <title>Enter fullscreen mode</title>
                      <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
                    </svg>

                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-off">
                      <title>Exit fullscreen mode</title>
                      <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
                    </svg>

                  </div>
                </div>
              </div>


              <p><strong><em>Note:</em></strong><br>
                <em>You may want to pay attention to the function assignCellValue — its purpose is to pre-assign a type
                  to column values. Simple trick — this function tells the JSON encoder which values ​​to accept as
                  non-numeric.</em><br>
                Benchmark:<br>
                <code>cpu: 11th Gen Intel(R) Core(TM) i5-1135G7 @ 2.40GHz<br>
BenchmarkRow2Map<br>
BenchmarkRow2Map-8     7376358        159.0 ns/op      336 B/op        2 allocs/op</code>
              </p>

              <p>Finally, execution time of our example — <a
                  href="https://github.com/oleg578/dbf/blob/mapping/example/main.go" target="_blank"
                  rel="noopener noreferrer">https://github.com/oleg578/dbf/blob/mapping/example/main.go</a><br>
                <code>% ./db2json_map 10000000 1&gt;/dev/null<br>
Elapsed time: 12152 ms, HeapAlloc = 8966.899 MB, Sys = 12248.287 MB<br>
10000000 records read</code>
              </p>

              <p>What can we say about these results?</p>

              <p>Benefits — We can obtain structures that are not predefined.</p>

              <p>Disadvantages — there are several.<br>
                But we pay for this with memory consumption.<br>
                It’s easy to see that such an implementation consumes 1.5 times more memory.</p>

              <p>The second disadvantage which can give us a headache are data types. We must define what we will access
                as numeric data, and what we will define as string. In current we use AssignValue auxiliary
                function:<br>
              </p>
              <div class="highlight js-code-highlight">
                <pre class="highlight go"><code><span class="k">func</span> <span class="n">assignCellValue</span><span class="p">(</span><span class="n">val</span> <span class="k">interface</span><span class="p">{})</span> <span class="k">interface</span><span class="p">{}</span> <span class="p">{</span>
 <span class="k">if</span> <span class="n">b</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">val</span><span class="o">.</span><span class="p">([]</span><span class="kt">byte</span><span class="p">);</span> <span class="n">ok</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">floatValue</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">strconv</span><span class="o">.</span><span class="n">ParseFloat</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="m">64</span><span class="p">);</span> <span class="n">err</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">floatValue</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kt">string</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="n">val</span>
<span class="p">}</span>
</code></pre>
                <div class="highlight__panel js-actions-panel">
                  <div class="highlight__panel-action js-fullscreen-code-action">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-on">
                      <title>Enter fullscreen mode</title>
                      <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
                    </svg>

                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-off">
                      <title>Exit fullscreen mode</title>
                      <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
                    </svg>

                  </div>
                </div>
              </div>


              <p>If value can be represented as float — then we define it as interface value (json library will define
                it as numeric or null), else as string.</p>

              <p>The third disadvantage is map structure property — we can’t guarantee order of fields in json. But this
                disadvantage may be unimportant.</p>

              <p>We cannot say that the result we got is satisfactory.He devours memory. On small datasets this may be
                acceptable, but this can negatively affect processing with large amounts of data.<br>
                <a href="https://github.com/oleg578/dbf/tree/mapping" target="_blank"
                  rel="noopener noreferrer">https://github.com/oleg578/dbf/tree/mapping</a>
              </p>
              <h2>
                <a name="what-can-we-improve" href="#what-can-we-improve" title="What can we improve?">
                </a>
                What can we improve?
              </h2>

              <p>Let’s look at the weak points in our algorithm of actions when we use maps.</p>

              <p>This a creating map[string]interface{} for each row — this very expensive operation in terms of
                resources and processor time;<br>
                And another too expensive operation — JSON marshaling the final slice which can be very big.</p>
              <h2>
                <a name="its-time-to-think-about-improvement" href="#its-time-to-think-about-improvement" title="It's time to think about improvement">
                </a>
                It’s time to think about improvement
              </h2>
              <h3>
                <a name="lets-play-with-data-structures" href="#lets-play-with-data-structures" title="Let’s play with data structures">
                </a>
                Let’s play with data structures
              </h3>

              <p>When fetching data from a SQL table, the order of columns is always defined by the database —
                deterministic and consistent across rows. This means we can skip the overhead of maps and instead rely
                on two coordinated slices: one holding column names, the other holding their corresponding values.
                It’s simpler, faster, and perfectly aligned with the way the database delivers data.</p>

              <p>The next refinement is to request values as byte slices and retrieve column metadata via <b>ColumnTypes</b>.
                This approach gives us type information up front while keeping data handling lightweight —
                an efficient foundation for streaming, type conversion, or dynamic encoding later on.<br>
              </p>
              <div class="highlight js-code-highlight">
                <pre class="highlight go"><code><span class="n">columns</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">rs</span><span class="o">.</span><span class="n">ColumnTypes</span><span class="p">()</span>
 <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"fault get column types: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="n">values</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="n">sql</span><span class="o">.</span><span class="n">RawBytes</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span>
 <span class="n">valuePointers</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="k">interface</span><span class="p">{},</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
 <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">values</span> <span class="p">{</span>
  <span class="n">valuePointers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
 <span class="p">}</span>
</code></pre>
                <div class="highlight__panel js-actions-panel">
                  <div class="highlight__panel-action js-fullscreen-code-action">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-on">
                      <title>Enter fullscreen mode</title>
                      <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
                    </svg>

                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-off">
                      <title>Exit fullscreen mode</title>
                      <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
                    </svg>

                  </div>
                </div>
              </div>


              <p>So, we are ready to fetch data in a new way and it’s time to serialize this data.<br>
                The JSON library is heavy, but we can make serialization easier.</p>

              <p>Columns are simple token-level data usually — we can turn them into JSON strings, then we will just
                escape special symbols by our escape function -<br>
              </p>
              <div class="highlight js-code-highlight">
                <pre class="highlight go"><code><span class="k">func</span> <span class="n">escape</span><span class="p">(</span><span class="n">in</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
 <span class="k">var</span> <span class="n">out</span> <span class="n">bytes</span><span class="o">.</span><span class="n">Buffer</span>
 <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">b</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">in</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">b</span> <span class="p">{</span>
  <span class="k">case</span> <span class="sc">'\n'</span><span class="p">,</span> <span class="sc">'\r'</span><span class="p">,</span> <span class="sc">'\t'</span><span class="p">,</span> <span class="sc">'\b'</span><span class="p">,</span> <span class="sc">'\f'</span><span class="p">,</span> <span class="sc">'\\'</span><span class="p">,</span> <span class="sc">'"'</span><span class="o">:</span>
   <span class="n">out</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="sc">'\\'</span><span class="p">)</span>
   <span class="n">out</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
  <span class="k">case</span> <span class="sc">'/'</span><span class="o">:</span>
   <span class="n">out</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="sc">'\\'</span><span class="p">)</span>
   <span class="n">out</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
  <span class="k">default</span><span class="o">:</span>
   <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="m">32</span> <span class="o">||</span> <span class="n">b</span> <span class="o">==</span> <span class="m">127</span> <span class="p">{</span>
    <span class="n">out</span><span class="o">.</span><span class="n">WriteString</span><span class="p">(</span><span class="s">`\u00`</span><span class="p">)</span>
    <span class="n">out</span><span class="o">.</span><span class="n">WriteString</span><span class="p">(</span><span class="n">strconv</span><span class="o">.</span><span class="n">FormatInt</span><span class="p">(</span><span class="kt">int64</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="m">16</span><span class="p">))</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">out</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
   <span class="p">}</span>
  <span class="p">}</span>
 <span class="p">}</span>
 <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="n">Bytes</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>
                <div class="highlight__panel js-actions-panel">
                  <div class="highlight__panel-action js-fullscreen-code-action">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-on">
                      <title>Enter fullscreen mode</title>
                      <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
                    </svg>

                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-off">
                      <title>Exit fullscreen mode</title>
                      <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
                    </svg>

                  </div>
                </div>
              </div>


              <p>Now let’s think about data types. We can determine the type of column (using sql ColumnType structure
                sql.ColumnType)<br>
              </p>
              <div class="highlight js-code-highlight">
                <pre class="highlight go"><code><span class="k">func</span> <span class="n">isDigit</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">sql</span><span class="o">.</span><span class="n">ColumnType</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
 <span class="k">switch</span> <span class="n">c</span><span class="o">.</span><span class="n">DatabaseTypeName</span><span class="p">()</span> <span class="p">{</span>
 <span class="k">case</span> <span class="s">"TINYINT"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"SMALLINT"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"MEDIUMINT"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"BIGINT"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"INT"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"INT1"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"INT2"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"INT3"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"INT4"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"INT8"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"BOOL"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"BOOLEAN"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"DECIMAL"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"DEC"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"NUMERIC"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"FIXED"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"NUMBER"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"FLOAT"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">case</span> <span class="s">"DOUBLE"</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">true</span>
 <span class="k">default</span><span class="o">:</span>
  <span class="k">return</span> <span class="no">false</span>
 <span class="p">}</span>
<span class="p">}</span>
</code></pre>
                <div class="highlight__panel js-actions-panel">
                  <div class="highlight__panel-action js-fullscreen-code-action">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-on">
                      <title>Enter fullscreen mode</title>
                      <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
                    </svg>

                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-off">
                      <title>Exit fullscreen mode</title>
                      <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
                    </svg>

                  </div>
                </div>
              </div>


              <p>And finally, let’s apply primitive serialization:<br>
              </p>
              <div class="highlight js-code-highlight">
                <pre class="highlight go"><code><span class="k">func</span> <span class="n">Row2Json</span><span class="p">(</span><span class="n">columns</span> <span class="p">[]</span><span class="o">*</span><span class="n">sql</span><span class="o">.</span><span class="n">ColumnType</span><span class="p">,</span> <span class="n">values</span> <span class="p">[]</span><span class="n">sql</span><span class="o">.</span><span class="n">RawBytes</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
 <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"no data in values"</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"columns and values length not equal"</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="k">var</span> <span class="n">buff</span> <span class="n">strings</span><span class="o">.</span><span class="n">Builder</span>
 <span class="n">buff</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="sc">'{'</span><span class="p">)</span>
 <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">values</span> <span class="p">{</span>
  <span class="n">buff</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="sc">'"'</span><span class="p">)</span>
  <span class="n">buff</span><span class="o">.</span><span class="n">WriteString</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Name</span><span class="p">())</span>
  <span class="n">buff</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="sc">'"'</span><span class="p">)</span>
  <span class="n">buff</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="sc">':'</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
   <span class="k">if</span> <span class="o">!</span><span class="n">isDigit</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">buff</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="sc">'"'</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="n">buff</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
   <span class="k">if</span> <span class="o">!</span><span class="n">isDigit</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">buff</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="sc">'"'</span><span class="p">)</span>
   <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
   <span class="n">buff</span><span class="o">.</span><span class="n">WriteString</span><span class="p">(</span><span class="s">"null"</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">-</span><span class="m">1</span> <span class="p">{</span>
   <span class="n">buff</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="sc">','</span><span class="p">)</span>
  <span class="p">}</span>
 <span class="p">}</span>
 <span class="n">buff</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="sc">'}'</span><span class="p">)</span>

 <span class="k">return</span> <span class="n">buff</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre>
                <div class="highlight__panel js-actions-panel">
                  <div class="highlight__panel-action js-fullscreen-code-action">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-on">
                      <title>Enter fullscreen mode</title>
                      <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
                    </svg>

                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-off">
                      <title>Exit fullscreen mode</title>
                      <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
                    </svg>

                  </div>
                </div>
              </div>


              <p>Benchmark:<br>
                <code>cpu: 11th Gen Intel(R) Core(TM) i5-1135G7 @ 2.40GHz<br>
BenchmarkRow2Json<br>
BenchmarkRow2Json-8     2881545        385.3 ns/op      440 B/op        9 allocs/op</code>
              </p>
              <h3>
                <a name="use-unix-way-to-output" href="#use-unix-way-to-output" title="Use UNIX way to output">
                </a>
                Use UNIX way to output
              </h3>

              <p>We will use UNIX way of output of our program — i.e. we will not create an output slice — we will out
                data into standard output stream instead — then we can use the output as a standard pipe in UNIX:<br>
              </p>
              <div class="highlight js-code-highlight">
                <pre class="highlight go"><code><span class="c">// create new buffer</span>
 <span class="n">writer</span> <span class="o">:=</span> <span class="n">bufio</span><span class="o">.</span><span class="n">NewWriter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">)</span>
 <span class="k">defer</span> <span class="n">writer</span><span class="o">.</span><span class="n">Flush</span><span class="p">()</span>

 <span class="n">writer</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="sc">'['</span><span class="p">)</span> <span class="c">//start print array of data</span>
 <span class="o">...</span>
 <span class="n">msg</span><span class="p">,</span> <span class="n">errMsg</span> <span class="o">:=</span> <span class="n">dbf</span><span class="o">.</span><span class="n">Row2Json</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
 <span class="o">...</span>
 <span class="k">if</span> <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">writer</span><span class="o">.</span><span class="n">WriteString</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
   <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"fault write row: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
  <span class="p">}</span> <span class="c">// write serialized row</span>
 <span class="o">...</span>
 <span class="n">writer</span><span class="o">.</span><span class="n">WriteByte</span><span class="p">(</span><span class="sc">']'</span><span class="p">)</span> <span class="c">// finish serialized slice</span>
</code></pre>
                <div class="highlight__panel js-actions-panel">
                  <div class="highlight__panel-action js-fullscreen-code-action">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-on">
                      <title>Enter fullscreen mode</title>
                      <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
                    </svg>

                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-off">
                      <title>Exit fullscreen mode</title>
                      <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
                    </svg>

                  </div>
                </div>
              </div>


              <p>In success execution we will get something like:<br>
              </p>
              <div class="highlight js-code-highlight">
                <pre class="highlight shell"><code>%  ./db2json_ds 3 2&gt;/dev/null | jq
<span class="o">[</span>
  <span class="o">{</span>
    <span class="s2">"id"</span>: 1,
    <span class="s2">"product"</span>: <span class="s2">"product_1"</span>,
    <span class="s2">"description"</span>: null,
    <span class="s2">"price"</span>: 1.23,
    <span class="s2">"qty"</span>: 10,
    <span class="s2">"date"</span>: <span class="s2">"2021-01-01 00:00:00"</span>
  <span class="o">}</span>,
  <span class="o">{</span>
    <span class="s2">"id"</span>: 2,
    <span class="s2">"product"</span>: <span class="s2">"product_2"</span>,
    <span class="s2">"description"</span>: null,
    <span class="s2">"price"</span>: 2.23,
    <span class="s2">"qty"</span>: 20,
    <span class="s2">"date"</span>: <span class="s2">"2021-01-01 00:00:00"</span>
  <span class="o">}</span>,
  <span class="o">{</span>
    <span class="s2">"id"</span>: 3,
    <span class="s2">"product"</span>: <span class="s2">"product_3"</span>,
    <span class="s2">"description"</span>: null,
    <span class="s2">"price"</span>: 3.23,
    <span class="s2">"qty"</span>: 30,
    <span class="s2">"date"</span>: <span class="s2">"2021-01-01 00:00:00"</span>
  <span class="o">}</span>
<span class="o">]</span>
</code></pre>
                <div class="highlight__panel js-actions-panel">
                  <div class="highlight__panel-action js-fullscreen-code-action">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-on">
                      <title>Enter fullscreen mode</title>
                      <path d="M16 3h6v6h-2V5h-4V3zM2 3h6v2H4v4H2V3zm18 16v-4h2v6h-6v-2h4zM4 19h4v2H2v-6h2v4z"></path>
                    </svg>

                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" viewbox="0 0 24 24"
                      class="highlight-action crayons-icon highlight-action--fullscreen-off">
                      <title>Exit fullscreen mode</title>
                      <path d="M18 7h4v2h-6V3h2v4zM8 9H2V7h4V3h2v6zm10 8v4h-2v-6h6v2h-4zM8 15v6H6v-4H2v-2h6z"></path>
                    </svg>

                  </div>
                </div>
              </div>


              <p>It’s a time of the moment of truth — fetch 10 million records:</p>

              <p><code>% ./db2json_ds 10000000 1&gt;/dev/null                                                                                                                              <br>
Elapsed time: 11894 ms, HeapAlloc = 2.436 MB, Sys = 11.710 MB<br>
10000000 records read</code><br>
                Let’s compare with the starting point:</p>

              <ul>
                <li>Execution time — 11.647 seconds instead 12.631 seconds;</li>
                <li>Memory consumption — 11.710 MB instead 7099.447 MB.
                  So, up to 10 percent faster and 600 times less memory consumption.</li>
              </ul>
              <h2>
                <a name="conclusion" href="#conclusion" title="Conclusion">
                </a>
                Conclusion
              </h2>

              <p>Let’s examine the broader scope of the tests.<br>
                Test comparison table (the length of result json file is 1.2Gb)<br>
              </p>
              <div class="ltag_gist-liquid-tag">
                <script id="gist-ltag"
                  src="https://gist.github.com/oleg578/95d264e62490498b4164d1fab696277a.js"></script>
              </div>



              <p>Benchmarks comparison table:<br>
              </p>
              <div class="ltag_gist-liquid-tag">
                <script id="gist-ltag"
                  src="https://gist.github.com/oleg578/3d87d82aa681ae3b2a0a8cdc7f1e84fd.js"></script>
              </div>


              <p>Real test memory consumption comparison table:<br>
              </p>
              <div class="ltag_gist-liquid-tag">
                <script id="gist-ltag"
                  src="https://gist.github.com/oleg578/90d81923746b0bc2be199c9081b8ddb3.js"></script>
              </div>


              <p>The fast method (fetch data using slices) is not the fastest in benchmarks, but it’s fastest and the
                least gluttonous in real tests.</p>

              <p>Analyzing the results, we can make two important conclusions, in my opinion :</p>

              <ul>
                <li>simple solutions always work more effectively;</li>
                <li>real tests are always more important than synthetic ones.</li>
              </ul>

              <p>Happy coding 🙂</p>


            </div>
          </div>
        </article>
      </main>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"
      referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"
      referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/shell.min.js"
      referrerpolicy="no-referrer"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('#main-content div.highlight__panel').forEach((panel) => panel.remove());
        document.querySelectorAll('#main-content div.highlight').forEach((wrapper) => {
          wrapper.classList.add('my-6');
        });
        document.querySelectorAll('#main-content .ltag_gist-liquid-tag').forEach((wrapper) => {
          wrapper.classList.add('my-6', 'overflow-hidden', 'rounded-2xl', 'border', 'border-slate-800', 'bg-slate-950/60');
        });
        document.querySelectorAll('#main-content pre').forEach((pre) => {
          const code = pre.querySelector('code');
          if (!code) {
            return;
          }
          const text = code.textContent;
          if (text) {
            code.textContent = text;
          }
          const language = Array.from(pre.classList).find((cls) => !['highlight', 'js-code-highlight'].includes(cls));
          const langToken = language ? language.replace(/^language-/, '') : 'plaintext';
          const normalizedLang = (langToken || 'plaintext').toLowerCase().replace(/[^a-z0-9+_-]/g, '') || 'plaintext';
          code.classList.add('hljs', 'language-' + normalizedLang);
          pre.className = 'overflow-x-auto rounded-2xl border border-slate-800 bg-slate-950/80 p-5 shadow-inner';
        });
        if (window.hljs?.highlightAll) {
          window.hljs.highlightAll();
        }
      });
    </script>
  </body>

</html>

